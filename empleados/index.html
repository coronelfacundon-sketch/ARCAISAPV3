<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ARCA – Empleados (Simulado)</title>
<style>
  :root{--pri:#0d5c63;--pri2:#157a85;--bg:#f4f7f8;--card:#fff;--txt:#122126;--ok:#1b7f5b;--warn:#b26a00;--err:#b00020;--muted:#5a6b70;--shadow:0 10px 30px rgba(0,0,0,.08)}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
  header{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;padding:24px 20px}
  .wrap{max-width:1100px;margin:0 auto;padding:18px} h1{margin:0;font-size:26px;font-weight:800} .sub{opacity:.9;margin-top:6px}
  .disc{background:#fff2;border-left:4px solid #fff7;padding:10px 12px;margin-top:10px;border-radius:10px;font-size:14px}
  nav .nav{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap} nav .nav a, nav .nav button{text-decoration:none;border:0;border-radius:10px;padding:8px 12px;background:#0d5c63;color:#fff;cursor:pointer;font-weight:700;display:inline-block}
  .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:18px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
  label{font-weight:650;font-size:14px}
  input,select{width:100%;padding:12px 11px;margin-top:6px;border:1px solid #d4dee1;border-radius:12px;background:#fbfeff;outline:none;transition:box-shadow .2s,border-color .2s}
  input:focus,select:focus{border-color:var(--pri2);box-shadow:0 0 0 3px rgba(21,122,133,.15)}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
  button{border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer} .btn{background:var(--pri);color:#fff} .btn.secondary{background:#e7eef0;color:#1b3136} .btn.ghost{background:transparent;border:2px solid #c6d7db;color:#234}
  .tile{background:#fff;border:1px solid #e6eef1;border-radius:16px;padding:18px;box-shadow:var(--shadow)} .tile h3{margin:0 0 10px 0} .tile p{margin:6px 0 14px 0;color:#345} .tile a,.tile button{width:100%}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  @media (max-width:780px){.col-8,.col-6,.col-4,.col-3{grid-column:span 12} }
  /* tablas empleados */
  table{width:100%;border-collapse:collapse} th,td{border:1px solid #e6eef1;padding:8px 10px;text-align:left;font-size:14px} th{background:#f3f8f9;font-weight:800}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800} .badge.ok{background:#e5f6ef;color:var(--ok)}
  .steps{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px} .step{flex:1 1 150px;background:#e8eff0;border-radius:12px;padding:8px 10px;display:flex;gap:10px;align-items:center} .step.active{background:#d1eef1;border:1px solid #9ad5db} .step .n{background:#0d5c63;color:#fff;border-radius:10px;padding:3px 8px;font-weight:800;min-width:26px;text-align:center}
  .errbox{font-size:12px;color:#fff;background:var(--err);padding:6px 8px;border-radius:10px;margin-top:8px;display:none} .errbox.show{display:inline-block}
  .tag{display:inline-block;padding:6px 10px;background:#eef5f6;border:1px solid #cfe1e4;border-radius:999px;margin:4px 6px 0 0;font-size:12px}
  .integrante{display:flex;gap:8px;margin-top:8px} .integrante input{flex:1}
  .const-card{padding:16px;background:#fff;border:1px solid #e3eef1;border-radius:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>ARCA – Simulación Educativa</h1>
    <div class="sub">Empleados de ARCA — acceso simulado</div>
    <div class="disc">Uso pedagógico. No envía datos a servidores ni organismos. No usar datos reales.</div>
    <nav><div class="nav">
      <a href="../">Inicio</a>
      <a href="../monotributo/">Monotributista</a>
      <a href="../ri/">Responsable Inscripto</a>
      <a href="../empleados/">Empleados</a>
    </div></nav>
  </div>
</header>
<main class="wrap">

<section class="card">
  <h2>Acceso</h2>
  <div id="empLoginBox">
    <div class="grid">
      <div class="col-4"><label>Usuario</label><input id="empUser" placeholder="Usuario"></div>
      <div class="col-4"><label>Contraseña</label><input id="empPass" type="password" placeholder="Contraseña"></div>
    </div>
    <div class="actions"><button class="btn" onclick="loginEmpleados()">Ingresar</button></div>
    <div id="empErr" class="errbox" style="display:none">Usuario/clave inválidos (simulado).</div>
    <div class="hint">Credenciales: <b>ARCA / ARCAISAP123</b> (simulado)</div>
  </div>

  <div id="empPanel" hidden>
    <div class="grid">
      <div class="col-6"><b>Inscripciones encontradas:</b> <span id="empCount">0</span></div>
      <div class="col-6" style="text-align:right"><button class="btn secondary" onclick="cerrarSesionEmp()">Cerrar sesión</button></div>
      <div class="col-12">
        <input id="empSearch" class="emp-search" placeholder="Buscar por nombre, apellido, curso, provincia…" oninput="renderTablaEmpleados()" />
        <div class="actions" style="justify-content:flex-start">
          <button class="btn ghost" onclick="exportarCSV()">Exportar CSV</button>
          <button class="btn ghost" onclick="exportarXLS()">Exportar XLS</button>
          <button class="btn secondary" onclick="borrarTodoLS()">Borrar todo (este navegador)</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <table id="empTable">
        <thead id="empHead"></thead>
        <tbody id="empBody"></tbody>
      </table>
    </div>
    <div class="hint">Lee registros guardados por Monotributo/RI en <code>LocalStorage</code>. Ahora incluye columnas IIBB y DFE.</div>
  </div>
</section>

<!-- Modal Constancia -->
<div id="cmModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:1100">
  <div class="card" style="width:min(900px,95vw);max-height:92vh;overflow:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <strong>Constancia (simulada)</strong>
      <button class="btn secondary" onclick="cerrarConstModal()">Cerrar</button>
    </div>
    <div id="cmContainer" class="const-card"></div>
    <div class="actions">
      <button class="btn ghost" onclick="abrirConstanciaNuevaPestaña()">Abrir en nueva pestaña</button>
      <button class="btn" onclick="imprimirConstancia()">Imprimir</button>
      <button class="btn" onclick="descargarConstanciaHTML()">Descargar HTML</button>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const KEYS=['arca_mono_regs_v2','arca_ri_regs_v1','arca_mono_regs_v1']; // compat con versiones previas
let EMP_DATA=[]; let CONSTANCIA_ACTUAL=null;
function loginEmpleados(){
  const u=($('#empUser').value||'').trim().toUpperCase();
  const p=($('#empPass').value||'').trim();
  const ok=(u==='ARCA' && p==='ARCAISAP123');
  $('#empErr').style.display = ok ? 'none':'inline-block';
  if(ok){ sessionStorage.setItem('arca_emp_ok','1'); $('#empLoginBox').hidden=true; $('#empPanel').hidden=false; cargar(); }
}
function cerrarSesionEmp(){ sessionStorage.removeItem('arca_emp_ok'); $('#empPanel').hidden=true; $('#empLoginBox').hidden=false; }
function leerRegistrosLS(){
  const acc=[];
  for(const k of Object.keys(localStorage)){
    if(!KEYS.includes(k)) continue;
    try{
      const arr=JSON.parse(localStorage.getItem(k)||'[]');
      if(Array.isArray(arr)){
        arr.forEach((r,idx)=> acc.push({...r,__key:k,__idx:idx,__tipo:(k.startswith('arca_ri')?'Resp. Inscripto':'Monotributista')}));
      }
    }catch(_){}
  }
  return acc;
}
function agencia(rec){ return (rec.provincia==='Buenos Aires')?'ARBA': (rec.provincia==='CABA'?'AGIP':'-'); }
function cargar(){
  EMP_DATA=leerRegistrosLS();
  $('#empCount').textContent=EMP_DATA.length;
  const cols=[
    {key:'__tipo',title:'Tipo'},
    {key:'fechaRegistro',title:'Fecha'},
    {key:'curso',title:'Curso'},
    {key:'apellido',title:'Apellido'},
    {key:'nombre',title:'Nombre'},
    {key:'email',title:'Email'},
    {key:'telefono',title:'Teléfono'},
    {key:'provincia',title:'Provincia'},
    {key:'actividad',title:'Actividad/Cód.'},
    {key:'condIIBB',title:'IIBB Cond.'},
    {key:'codIIBB',title:'IIBB Código'},
    {key:'fechaIIBB',title:'IIBB Alta'},
    {key:'jurPrincipal',title:'CM Sede'},
    {key:'dfe',title:'DFE'},
    {key:'regSimplif',title:'Rég. Simplif.'},
    {key:'validado',title:'Validado'}
  ];
  $('#empHead').innerHTML='<tr>'+cols.map(c=>`<th>${c.title}</th>`).join('')+'<th>Acciones</th></tr>';
  $('#empTable').dataset.cols=JSON.stringify(cols);
  renderTablaEmpleados();
}
function renderTablaEmpleados(){
  const cols=JSON.parse($('#empTable').dataset.cols||'[]');
  const q = ($('#empSearch').value||'').toLowerCase();
  const filtrado = EMP_DATA.filter(r=>{
    const s=[r.__tipo||'',r.apellido||'',r.nombre||'',r.curso||'',r.email||'',r.actividad||'',r.provincia||'',r.condIIBB||'',r.codIIBB||'',r.jurPrincipal||''].join(' ').toLowerCase();
    return s.includes(q);
  });
  const rows=filtrado.map(r=>{
    const tds=cols.map(c=>{
      let v=r[c.key];
      if(c.key==='fechaRegistro'&&v){ try{ v=new Date(v).toLocaleString('es-AR'); }catch(_){ } }
      if(c.key==='validado'){ v=r.validado?'Sí':'No'; }
      return `<td>${v??''}</td>`;
    }).join('');
    return `<tr>${tds}<td>
      <button class="btn secondary" onclick="verConstanciaEmp('${r.__key}',${r.__idx})">Ver constancia</button>
      <button class="btn ghost" onclick="toggleValidado('${r.__key}',${r.__idx})">${r.validado?'Desmarcar':'Marcar'} validado</button>
      <button class="btn" onclick="eliminarRegistro('${r.__key}',${r.__idx})">Eliminar</button>
    </td></tr>`;
  }).join('');
  $('#empBody').innerHTML = rows || '<tr><td colspan="99">No hay registros.</td></tr>';
}
function guardarArrayEnKey(key, arr){ try{ localStorage.setItem(key, JSON.stringify(arr)); }catch(_){ } }
function toggleValidado(key, idx){
  try{ const arr=JSON.parse(localStorage.getItem(key)||'[]'); if(!Array.isArray(arr)||!arr[idx])return; arr[idx].validado=!arr[idx].validado; guardarArrayEnKey(key,arr); cargar(); }catch(_){}
}
function eliminarRegistro(key, idx){
  if(!confirm('¿Eliminar este registro?')) return;
  try{ const arr=JSON.parse(localStorage.getItem(key)||'[]'); if(!Array.isArray(arr)||!arr[idx])return; arr.splice(idx,1); guardarArrayEnKey(key,arr); cargar(); }catch(_){}
}
// Exportadores
function toCSV(rows){
  const cols=JSON.parse($('#empTable').dataset.cols||'[]');
  const head=cols.map(c=>`"${c.title}"`).join(',');
  const body=rows.map(r=> cols.map(c=>{
    let val=(c.key==='fechaRegistro'&&r.fechaRegistro)?new Date(r.fechaRegistro).toLocaleString('es-AR'):(c.key==='validado'?(r.validado?'Sí':'No'):(r[c.key]??''));
    return `"${
      String(val).replaceAll('"','""')
    }"`;
  }).join(',')).join('\n');
  return head+'\n'+body;
}
function descargar(nombre,blob){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=nombre; a.click(); URL.revokeObjectURL(url); }
function exportarCSV(){ const csv=toCSV(EMP_DATA); descargar('registros_ARCA.csv', new Blob([csv],{type:'text/csv'})); }
function exportarXLS(){
  const cols=JSON.parse($('#empTable').dataset.cols||'[]');
  const thead='<tr>'+cols.map(c=>`<th>${c.title}</th>`).join('')+'</tr>';
  const tbody=EMP_DATA.map(r=>{
    const tds=cols.map(c=>{
      let v=(c.key==='fechaRegistro'&&r.fechaRegistro)?new Date(r.fechaRegistro).toLocaleString('es-AR'):(c.key==='validado'?(r.validado?'Sí':'No'):(r[c.key]??''));
      return `<td>${String(v).replaceAll('&','&amp;').replaceAll('<','&lt;')}</td>`;
    }).join('');
    return `<tr>${tds}</tr>`;
  }).join('');
  const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body><table border="1"><thead>${thead}</thead><tbody>${tbody}</tbody></table></body></html>`;
  descargar('registros_ARCA.xls', new Blob([html],{type:'application/vnd.ms-excel'}));
}
function buildConstanciaHTML(rec){
  const ints=(rec.integrantes||'').split(' | ').filter(Boolean);
  const integrantesHTML = `<div><b>Grupo (${rec.curso||''}):</b> ${ints.length?ints.join(', '):'-'}</div>`;
  const ag = (rec.provincia==='Buenos Aires')?'ARBA':(rec.provincia==='CABA'?'AGIP':'ARBA/AGIP');
  return `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Constancia ${rec.codigo||''}</title>
  <style>body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:24px;background:#f4f7f8;color:#122126}.const{max-width:820px;margin:0 auto;background:#fff;border:1px solid #e3eef1;border-radius:12px;padding:18px}.hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.badge{display:inline-block;background:#e5f6ef;color:#1b7f5b;padding:6px 10px;border-radius:999px;font-weight:800}.row{line-height:1.7;margin-top:6px}.mut{color:#5a6b70;font-size:12px;margin-top:10px}</style></head><body>
   <div class="const"><div class="hdr"><b>ARCA – Simulación Educativa (ISAP)</b><div class="badge">Válida solo para prácticas escolares</div></div>
     <div class="row">${integrantesHTML}
       <div><b>Contribuyente:</b> ${rec.apellido||''}, ${rec.nombre||''} — ${rec.tipoDoc||''} ${rec.nroDoc||''} ${rec.cuit?('— CUIT/CUIL '+rec.cuit):''}</div>
       <div><b>Contacto:</b> ${rec.email||''} / ${rec.telefono||''}</div>
       <div><b>Domicilio fiscal:</b> ${rec.calle||''} ${rec.numero||''} ${rec.piso?('('+rec.piso+')'):''}, ${rec.localidad||''}, ${rec.provincia||''} (${rec.cp||''})</div>
       <div><b>Actividad:</b> ${rec.actividad||''} — ${rec.actDesc||''} — <b>Inicio:</b> ${rec.fechaInicio||''} — PV: ${rec.pventa||''} — Empleados: ${rec.empleados||''}</div>
       <div><b>IIBB ${ag}:</b> ${(rec.condIIBB||'')}${rec.jurPrincipal?(' ('+rec.jurPrincipal+')'):''} — Cód: ${(rec.codIIBB||'')} — Alta: ${(rec.fechaIIBB||'')} — DFE: ${(rec.dfe||'')} — Régimen simplificado: ${(rec.regSimplif||'')}</div>
       <div><b>Régimen:</b> ${(rec.__tipo||'')}</div>
       <div><b>Fecha (simulada):</b> ${(rec.fechaRegistro?new Date(rec.fechaRegistro).toLocaleString('es-AR'):new Date().toLocaleString('es-AR'))}</div>
     </div>
     <div class="mut">Código verificación (ficticio): <b>${rec.codigo||'-'}</b></div>
   </div></body></html>`;
}
function verConstanciaEmp(key, idx){
  try{
    const arr=JSON.parse(localStorage.getItem(key)||'[]'); const rec=Array.isArray(arr)?arr[idx]:null; if(!rec) return;
    CONSTANCIA_ACTUAL = {...rec,__tipo:(key.startswith('arca_ri')?'Resp. Inscripto':'Monotributista')};
    const html=buildConstanciaHTML(CONSTANCIA_ACTUAL);
    $('#cmContainer').innerHTML = html.split('<body>')[1].split('</body>')[0];
    $('#cmModal').style.display='grid';
  }catch(_){}
}
function cerrarConstModal(){ $('#cmModal').style.display='none'; }
function imprimirConstancia(){ if(!CONSTANCIA_ACTUAL) return; const w=window.open('','_blank'); w.document.open(); w.document.write(buildConstanciaHTML(CONSTANCIA_ACTUAL)); w.document.close(); w.onload=()=>w.print(); }
function descargarConstanciaHTML(){ if(!CONSTANCIA_ACTUAL) return; const blob=new Blob([buildConstanciaHTML(CONSTANCIA_ACTUAL)],{type:'text/html'}); const nombre=`constancia_${(CONSTANCIA_ACTUAL.__tipo||'')}_${(CONSTANCIA_ACTUAL.codigo||'simulada')}.html`; const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=nombre; a.click(); URL.revokeObjectURL(url); }
function abrirConstanciaNuevaPestaña(){ if(!CONSTANCIA_ACTUAL) return; const w=window.open('','_blank'); w.document.open(); w.document.write(buildConstanciaHTML(CONSTANCIA_ACTUAL)); w.document.close(); }
if(sessionStorage.getItem('arca_emp_ok')==='1'){ $('#empLoginBox').hidden=true; $('#empPanel').hidden=false; cargar(); }
window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') cerrarConstModal(); });
</script>
</main>
</body>
</html>
